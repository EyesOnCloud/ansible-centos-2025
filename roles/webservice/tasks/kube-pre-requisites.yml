---
- hosts: "controller, workers"
  become: yes
  tasks:
    - name: Disabling Swap on all nodes
      become: yes
      ansible.builtin.shell: swapoff -a
    - name: Commenting Swap entries in /etc/fstab
      become: yes
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^([^#].*\bswap\b.*)'
        replace: '# \1'
    - name: Commenting Swap entries in /etc/fstab
      become: yes
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^([^#].*\bswap\b.*)'
        replace: '# \1'
    - name: Ensure overlay and br_netfilter modules are loaded
      ansible.builtin.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter
    - name: Ensure Kubernetes sysctls are set
      ansible.builtin.copy:
        dest: /etc/sysctl.d/kubernetes.conf
        content: |
          net.bridge.bridge-nf-call-ip6tables = 1
          net.bridge.bridge-nf-call-iptables = 1
          net.ipv4.ip_forward = 1
        mode: '0644'
    - name: Apply sysctl settings
      ansible.builtin.command: sysctl --system
    - name: Load overlay and br_netfilter on boot
      ansible.builtin.copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
        mode: '0644'
    - name: Install dnf-plugins-core
      dnf:
        name: dnf-plugins-core
        state: present
      become: true
    - name: Add Docker CE repository
      command: >
        dnf config-manager --add-repo
        https://download.docker.com/linux/rhel/docker-ce.repo
      become: true
    - name: Install containerd package
      ansible.builtin.yum:
        name: containerd.io
        state: present
    - name: Create /etc/containerd directory
      ansible.builtin.file:
        path: /etc/containerd
        state: directory
        mode: '0755'
    - name: Generate default containerd config
      ansible.builtin.command: containerd config default
      register: containerd_default_config
    - name: Write containerd config to file
      ansible.builtin.copy:
        dest: /etc/containerd/config.toml
        content: "{{ containerd_default_config.stdout }}"
        mode: '0644'
    - name: Enable SystemdCgroup in config.toml
      ansible.builtin.replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'
    - name: Create /etc/crictl.yaml
      ansible.builtin.copy:
        dest: /etc/crictl.yaml
        content: |
          runtime-endpoint: unix:///var/run/containerd/containerd.sock
          image-endpoint: unix:///var/run/containerd/containerd.sock
          timeout: 10
        mode: '0644'
    - name: Restart containerd service
      ansible.builtin.service:
        name: containerd
        state: restarted
        enabled: true
    - name: Create Kubernetes repo file
      ansible.builtin.copy:
        dest: /etc/yum.repos.d/kubernetes.repo
        mode: '0644'
        content: |
          [kubernetes]
          name=Kubernetes
          baseurl=https://pkgs.k8s.io/core:/stable:/v1.34/rpm/
          enabled=1
          gpgcheck=1
          gpgkey=https://pkgs.k8s.io/core:/stable:/v1.34/rpm/repodata/repomd.xml.key
          exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
    - name: Install Kubernetes packages (version 1.34.0)
      ansible.builtin.yum:
        name:
          - kubelet-1.34.0
          - kubeadm-1.34.0
          - kubectl-1.34.0
        state: present
        disable_excludes: kubernetes
    - name: Starting Kubelet Service
      ansible.builtin.service:
        name: kubelet
        enabled: true
